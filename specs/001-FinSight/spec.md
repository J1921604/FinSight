# 機能仕様書: FinSight — 財務諸表インサイトダッシュボード

**機能ブランチ**: `001-FinSight`  
**作成日**: 2025-11-28  
**ステータス**: Draft  
**入力**: AI_inputフォルダ全ファイルに基づき、FinSight（PL/BS/CF＋注記）アプリのみを実装する

**憲法準拠**: 本仕様は`.specify/memory/constitution.md`の原則1-5に準拠します。
- テスト駆動開発の徹底（受入シナリオ必須）
- セキュリティ要件の優先（機密データ取扱の明記）
- パフォーマンス基準の定量化（成功基準に含める）
- 再現性の確保（データモデルのバージョニング）
- CI/CD統合（デプロイメント要件の明記）

---

## ユーザーシナリオ & テスト *(必須)*

### ユーザーストーリー 1 - PL/BS/CF四半期推移の可視化 (優先度: P1)

**概要**: 東京電力HDおよび中部電力の損益計算書（PL）、貸借対照表（BS）、キャッシュフロー計算書（CF）の四半期データを時系列グラフで表示し、業績トレンドを直感的に把握できる。

**この優先度の理由**: これは財務分析の最も基本的な機能であり、すべての財務判断の出発点となる。この機能がなければFinSightの価値が成立しない。

**独立テスト**: 
- EDINET APIから取得したCSV ZIPファイルをdata/financials/配下に配置
- PL/BS/CFタブを切り替えて各諸表のグラフが正しくレンダリングされることを確認
- 少なくとも直近4四半期分のデータポイントが表示される
- これだけでMVP（最小限の価値提供）として機能する

**受入シナリオ**:

1. **Given** data/financials/TEPCO_pl_quarterly.csvに過去4四半期のPLデータが存在する、**When** ユーザーが「損益計算書」タブをクリックする、**Then** 売上高・営業利益・経常利益・当期純利益の4つの折れ線グラフが表示される
2. **Given** グラフが表示されている状態、**When** ユーザーがグラフ上の特定データポイントにホバーする、**Then** その四半期の正確な金額（億円単位、小数点以下1桁）がツールチップで表示される
3. **Given** TEPCO/CHUBUの両社データが存在する、**When** 「比較モード」トグルをONにする、**Then** 両社のグラフが同一チャート上に異なる色（TEPCO=シアン、CHUBU=マゼンタ）で重ね合わせ表示される

---

### ユーザーストーリー 2 - 前年同期比較とハイライト表示 (優先度: P1)

**概要**: 現在の四半期データを前年同期と比較し、主要項目の増減率を色分けハイライト表示する。

**この優先度の理由**: 前年同期比（YoY）は財務分析の標準指標であり、業績の改善・悪化を即座に判断するために必須。P1機能と組み合わせることで分析の実用性が大幅に向上する。

**独立テスト**: 
- 2024Q2と2025Q2のデータを用意
- 売上高が前年同期比+10%の場合、緑色のハイライトと「+10.0%」のバッジが表示される
- 営業利益が前年同期比-5%の場合、赤色のハイライトと「-5.0%」のバッジが表示される

**受入シナリオ**:

1. **Given** 2024Q2と2025Q2のPLデータが存在する、**When** 2025Q2のデータを表示する、**Then** 各項目の横に前年同期比の増減率バッジ（例: "+12.3%"）が表示される
2. **Given** 前年同期比が+5%以上の項目、**When** バッジが表示される、**Then** バッジの背景色は緑（#00FF84）になる
3. **Given** 前年同期比が-5%以下の項目、**When** バッジが表示される、**Then** バッジの背景色は赤（#FF4757）になる
4. **Given** 前年同期比が-5%〜+5%の範囲の項目、**When** バッジが表示される、**Then** バッジの背景色は黄色（#FFB800）になる

---

### ユーザーストーリー 3 - 資産構成比の可視化 (優先度: P2)

**概要**: 貸借対照表の流動資産/固定資産の構成比を円グラフまたは積み上げ棒グラフで表示し、資産バランスを視覚化する。

**この優先度の理由**: 資産構成の理解は財務健全性の評価に重要だが、P1機能（推移とYoY比較）があれば基本的な分析は可能。この機能は分析の深度を増すための補完機能。

**独立テスト**: 
- TEPCO_bs_quarterly.csvから最新四半期のBS データを読み込み
- 流動資産60%、固定資産40%の場合、円グラフでその割合が正しく表示される

**受入シナリオ**:

1. **Given** 最新四半期のBSデータが存在する、**When** 「資産構成」セクションを表示する、**Then** 流動資産と固定資産の割合を示す円グラフが表示される
2. **Given** 流動資産が総資産の60%を占める、**When** 円グラフが表示される、**Then** 流動資産セクタが全体の60%を占め、「60.0%」のラベルが表示される
3. **Given** 過去4四半期のBSデータが存在する、**When** 「構成推移」モードに切り替える、**Then** 四半期ごとの流動/固定資産比率の推移が積み上げ棒グラフで表示される

---

### ユーザーストーリー 4 - 注記からのリスク情報抽出（NLP） (優先度: P2)

**概要**: XBRLの注記情報から自然言語処理（NLP）を用いてリスクキーワード（「訴訟」「減損」「規制」など）を抽出し、重要度スコア付きでリスト表示する。

**この優先度の理由**: 注記分析は高度な機能であり、基本的な財務数値分析（P1）が完了してから付加価値として提供する。NLPの精度は100%ではないため、出典（docID）へのリンクを必ず併記し、ユーザーが原文を確認できるようにする。

**独立テスト**: 
- data/xbrl_notes.jsonにサンプルの注記データ（「原子力損害賠償に関する訴訟」を含むテキスト）を配置
- NLPスクリプト（nlp_notes_risk.py）を実行し、「訴訟」キーワードが検出される
- severity: 0.8のスコアが付与され、UIで「高リスク」として赤色ハイライト表示される

**受入シナリオ**:

1. **Given** 注記に「減損損失を計上する可能性がある」というテキストが含まれる、**When** NLP分析を実行する、**Then** 「減損」キーワードが抽出され、severityスコア0.6〜0.8の範囲で評価される
2. **Given** 抽出されたリスク項目のseverityが0.7以上、**When** リスクパネルで表示する、**Then** 項目の左側に赤色の縦バー（border-left: 4px solid #FF4757）が表示される
3. **Given** リスク項目が表示されている、**When** ユーザーが項目をクリックする、**Then** 元のEDINET書類（docID）へのリンクが新しいタブで開き、該当セクションに直接ジャンプする

---

### ユーザーストーリー 5 - 会計方針変更の自動検知 (優先度: P3)

**概要**: 前回提出された注記と今回の注記を比較し、「会計方針の変更」「重要な会計上の見積り」などの記載内容の差分を自動検出する。

**この優先度の理由**: これは専門的な監査機能であり、一般ユーザーよりも財務アナリストや監査関係者向けの高度な機能。MVP範囲外だが、将来的な差別化要因となる。

**独立テスト**: 
- 2024Q2と2025Q2の注記JSONファイルを用意
- 2025Q2に「収益認識に関する会計基準を適用」という新規記載がある場合、差分検出スクリプトがこれを「policy_change」としてタグ付けする

**受入シナリオ**:

1. **Given** 前回期（2024Q2）の注記に存在しなかった「減価償却方法の変更」という文言が今回期（2025Q2）に出現する、**When** 差分検出を実行する、**Then** この変更が「会計方針変更」としてフラグ付けされる
2. **Given** 会計方針変更が検出された、**When** 注記パネルで表示する、**Then** 変更項目に「NEW」バッジ（背景色: #FFB800）が付与され、変更前後のテキストが並列表示される
3. **Given** 3期連続で同じ会計方針が継続している、**When** 差分検出を実行する、**Then** 「変更なし」のステータスが表示され、ユーザーに継続性が明示される

---

### エッジケース

**データ欠損時の挙動**:
- 特定の四半期データが存在しない場合、グラフ上でその期間をスキップ（線が途切れる）するのではなく、データポイント間を破線で補完し、「データなし」のツールチップを表示する。

**EDINET APIエラー時の挙動**:
- APIキーが無効または期限切れの場合、GitHub Actionsワークフローは即座に停止し、`edinet-auth-failure`ラベル付きのIssueを自動起票する。
- CSV ZIPのダウンロードに失敗した場合、最大3回のリトライ（10秒間隔）を実行し、それでも失敗した場合は前回成功時のキャッシュデータ（data/financials/.cache/）を使用する。

**NLPの誤検知への対応**:
- NLPで抽出されたリスク情報は、必ず出典（docID + セクション名）へのリンクを併記する。
- UIに「この分析はAIによる自動抽出です。正確性を保証するものではありません」という免責事項を表示する。

**タクソノミの年度差分への対応**:
- EDINETのタクソノミは年度ごとに要素名が変わる可能性がある（例: 2023年版「受取配当金」→ 2024年版「受取配当金（四半期）」）。
- taxonomy_map.jsonにエイリアステーブルを定義し、複数の候補ラベルを許容する。
- マッピングに失敗した場合、ログに警告を出力し、data/unmapped_labels.jsonに未マッピングラベルを記録して後続の手動修正を可能にする。

---

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは EDINET API v2 を使用して、指定されたEDINETコード（E04498: 東電HD、E04503: 中部電力）の有価証券報告書および四半期報告書のCSV変換ZIP（type=5）をダウンロードできなければならない
- **FR-002**: システムは ダウンロードしたZIPファイルを解凍し、単独財務諸表のCSVファイルから損益計算書（PL）、貸借対照表（BS）、キャッシュフロー計算書（CF）の勘定科目と金額を抽出できなければならない
- **FR-003**: システムは 抽出した財務データをdata/financials/{company}_{statement}_quarterly.csv形式で保存し、Gitコミット履歴によるバージョン管理を行わなければならない
- **FR-004**: システムは PL/BS/CFの四半期推移を折れ線グラフで表示し、各データポイントにホバー時のツールチップ（金額、期間、前年同期比）を提供しなければならない
- **FR-005**: システムは 前年同期比（YoY）を自動計算し、+5%以上を緑、-5%以下を赤、その間を黄色でハイライト表示しなければならない
- **FR-006**: システムは BSの流動資産/固定資産構成比を円グラフで可視化し、割合をパーセンテージラベル付きで表示しなければならない
- **FR-007**: システムは XBRLの注記テキストをパースし、リスクキーワード（訴訟、減損、引当金、規制、原子力など）をキーワード辞書とマッチングして抽出しなければならない
- **FR-008**: システムは 抽出されたリスク情報にseverityスコア（0.0〜1.0）を付与し、0.7以上を高リスク（赤）、0.4〜0.7を中リスク（黄）、0.4未満を低リスク（青）として分類しなければならない
- **FR-009**: システムは 前回期と今回期の注記テキストを比較し、「会計方針の変更」セクションの差分を検出できなければならない
- **FR-010**: システムは すべてのデータ更新処理をGitHub Actionsワークフローで自動化し、毎週月曜6:00 UTC（日本時間15:00）に定期実行しなければならない
- **FR-011**: システムは Viteでビルドした静的サイト（dist/）をGitHub Pagesにデプロイし、https://{username}.github.io/FinSight/ でアクセス可能にしなければならない

### 主要エンティティ *(データモデルに関連)*

- **財務諸表データ（CSV）**: 
  - 属性: company (string), period (string, 形式: YYYYQQ), date (ISO8601), 勘定科目列（revenue, operating_income, net_income等）
  - 関係: 各社（TEPCO/CHUBU）ごとに独立したCSVファイルとして保存
  
- **注記データ（JSON）**:
  - 属性: company, period, docID, category ("risk" | "policy_change" | "info"), text, severity (number 0.0-1.0), keywords (string[]), detected_at (ISO8601)
  - 関係: 各書類（docID）ごとに複数の注記項目が含まれる配列構造

- **タクソノミマッピング（JSON）**:
  - 属性: taxonomy_version (string),勘定科目名 → エイリアス配列のマッピング
  - 関係: 年度ごとのバージョン管理、複数の候補ラベルを許容

---

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーはFinSightダッシュボードを開いてから2.5秒以内にPLグラフの初回描画（LCP）を完了できる（Lighthouse計測）
- **SC-002**: システムは週次の自動データ更新ワークフローを95%以上の成功率で実行できる（過去3ヶ月の履歴に基づく）
- **SC-003**: NLPによるリスク抽出の再現率（Recall）は80%以上である（手動ラベル付けされたサンプル注記100件に対する評価）
- **SC-004**: ユーザーはPL/BS/CF間のタブ切り替えを200ms以内に完了できる（React Profilerで計測）
- **SC-005**: システムは同時に100ユーザーのアクセスを処理しても応答時間が500ms以下である（GitHub Pages静的サイトの特性により、CDN配信で自動的に達成）
- **SC-006**: ユーザーは初回訪問時に操作方法を説明するチュートリアルなしで、3分以内に目的の財務指標（例: 営業利益のYoY比較）を見つけられる（ユーザビリティテスト n=5の平均値）
- **SC-007**: EDINET APIからのデータ取得失敗時、システムは5分以内にGitHub Issueを自動起票し、開発チームに通知できる
- **SC-008**: バンドルサイズ（gzip後）は200KB以下である（webpack-bundle-analyzerで計測）

---

## 技術詳細（参考情報）

本セクションは実装チームへの参考情報であり、仕様の一部ではありません。

### 推奨技術スタック
- フロントエンド: React 18 + TypeScript + Vite
- チャートライブラリ: Recharts
- スタイリング: Tailwind CSS（Cyberpunk Neumorphismデザインシステム）
- バックエンド処理: Python 3.11（spaCyまたはtransformersでNLP）
- データ取得: EDINET API v2（APIキー必須、公式仕様書 ESE140206.pdf 準拠）

### データ更新フロー（推奨）
1. GitHub Actions cronジョブ（毎週月曜15:00 JST）起動
2. `scripts/fetch_edinet.py`がEDINET API v2の一覧API（`/documents.json`）を呼び出し
3. 東電HD（E04498）と中部電力（E04503）の最新の四半期報告書のdocIDを取得
4. `type=5`パラメータでCSV変換ZIPをダウンロード
5. `scripts/extract_financials.py`がZIPを解凍し、PL/BS/CFのCSVをパース
6. data/financials/配下にCSVファイルとして保存
7. `scripts/nlp_notes_risk.py`がXBRL注記を抽出・分析してdata/xbrl_notes.jsonに保存
8. Gitコミット & プッシュ → 自動的にGitHub Pagesデプロイがトリガー

### パフォーマンス最適化（推奨）
- データ遅延読み込み: 初回レンダリング時はPLのみロード、BS/CFは遅延ロード
- チャートの仮想化: データポイントが100を超える場合、react-windowで仮想スクロール
- 画像最適化: ロゴやアイコンはSVG形式、必要に応じてWebP形式

---

## 付録: EDINET API v2 統合仕様

### API認証
- ヘッダー: `Subscription-Key: {YOUR_API_KEY}` または クエリパラメータ: `?Subscription-Key={YOUR_API_KEY}`
- GitHub Secretsに`EDINET_API_KEY`として登録（Settings > Secrets and variables > Actions）

### 書類一覧API
```
GET https://api.edinet-fsa.go.jp/api/v2/documents.json?date=YYYY-MM-DD&type=2
```
- `type=2`: 有価証券報告書・四半期報告書等を対象
- レスポンス例:
```json
{
  "results": [
    {
      "docID": "S100XXXXX",
      "edinetCode": "E04498",
      "docDescription": "四半期報告書",
      "submitDateTime": "2025-11-15 09:00",
      "periodEnd": "2025-09-30"
    }
  ]
}
```

### 書類取得API（CSV変換）
```
GET https://api.edinet-fsa.go.jp/api/v2/documents/{docID}?type=5
```
- `type=5`: CSV変換されたZIPファイルを取得
- 応答: バイナリZIPファイル（application/zip）
- ZIP内構造: 複数のCSVファイル（勘定科目ごとに分割されている場合あり）

### タクソノミマッピング例
data/taxonomy_map.json:
```json
{
  "schema_version": "1.0.0",
  "mappings": {
    "revenue": ["売上高", "営業収益", "Revenue", "OperatingRevenue"],
    "operating_income": ["営業利益", "OperatingIncome"],
    "net_income": ["当期純利益", "親会社株主に帰属する当期純利益", "NetIncome"]
  }
}
```

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-11-28 | 1.0 | 初版作成（AI_inputフォルダ全ファイルに基づく統合仕様） |
